{% extends "base.html" %}
{% block headcss %}
<link rel="stylesheet" href="/static/lib/leaflet/leaflet.css" type="text/css">
<link rel="stylesheet" href="/static/lib/fwo/maps.css" type="text/css">
<style>
	ul#feedback-list small {
		color:#888;
	}
	ul#feedback-list p.comment-body {
		margin:0;
	}
	p#comment-body {
		margin-bottom:0;
	}
	p.reply-body {
		padding-top:5px;padding-left:22px;padding-right:150px;
	}
	ul#comment-replies {
		margin-bottom:0;
	}
	ul#comment-replies li {
		margin-bottom:0;
		padding-bottom:0;
	}
</style>
{% endblock %}
{% block footjs %}
<script type="text/javascript" src="/static/lib/leaflet/leaflet.js"></script>
<script type="text/javascript" src="/static/lib/fwo/fieldworkonline-map.js"></script>
<script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=Rb8mk6WhnRbq72GpHLRGXnkX5u35Ou3K "></script>
<script type="text/javascript">
	$(document).ready(function(){
		/*
            Set some init values that will be used by FWO.map.init()
            */
		FWO.config = {
			'map_state':       "{{feedback.map_state}}",
			'map_view':        "{{feedback.map_view}}",
			'map_marker':      "{{feedback.map_marker}}"
		}

		/*
            Fetch the map layers from the JSON document generated by the project_data_maplayers
            view.
            */
		FWO.map.fetch_map("{{url_for('project_data_maplayers', slug=project.slug, user_id=user.id)}}")
	})
</script>
{% endblock %}
{% block content %}
&nbsp;
{% if not feedback %}
<!-- a message will be displayed in a flash() -->
{% else %}
<div class="row">
	<div class="col-md-4 col-sm-4">
		<div class="panel panel-default">
			<div class="panel-heading">
				<strong>Overview of recent comments and feedback</strong>
			</div>
			<ul class="list-group" id="feedback-list" style="height:340px;overflow-y:scroll;" >
				{% for comment in recentcomments %}
				<a href="{{url_for('project_feedback_detail', slug=project.slug, user_id=user.id, comment_id=comment.id)}}" class="list-group-item feedback-link {% if comment.id == feedback.id %} active {% endif %}" data-comment-id="{{comment.id}}">
					<strong>Comment by {{comment.comment_by_user.username}}</strong>
					<span style="float:right;">{{comment.comment_age}} ({{comment.num_of_replies}} replies)</span>
					<p class="comment-body">{{comment.comment_body_truncated}}</p>
				</a>
				{% endfor %}
			</ul>

		</div>
	</div>
	<div class="col-md-8 col-sm-8">
		<div class="panel panel-default" >
			<div class="panel-heading">
				<strong>Map</strong>
			</div>
			<div class="panel-body" id="map"  style="padding:0;margin:0;height:340px;">
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-12 col-sm-12">
		<div class="panel panel-default" id="comment-detail">
			<div class="panel-heading">
				<strong><i class="fa fa-quote-left"></i> Original comment by <span id="comment-by">{{feedback.comment_by_user.username}}</span></strong> posted <span id="comment-age">{{feedback.comment_age}}</span>
			</div>
			<div class="panel-body" id="feedback-detail">
				<div class="comment-original">
					<p id="comment-body">{{feedback.comment_body}}</p>
				</div>
				<ul class="list-group" id="comment-replies" >
					{% for reply in feedback.comment_children %}
					<li class="list-group-item" style="border:none;padding-left:0px;"><strong><i class="fa fa-reply fa-rotate-180 fa-fw"></i> Reply by {{reply.comment_by_user.username}}</strong> posted {{reply.comment_age}}
						<p class="reply-body">{{reply.comment_body}}</p></li>
					{% endfor %}
				</ul>
			</div>
			<div class="panel-body" id="feedback-reply" style="background-color:#f5f5f5;border-top:1px solid #ddd;">
				<form id="comment-reply-form" method="POST" action="{{url_for('project_feedback', slug=project.slug, user_id=user.id)}}">
					<input name="comment_parent" id="comment-parent" type="hidden" value="{{feedback.id}}">
					<input name="redirect" type="hidden" value="yes">
					<div class="form-group" style="margin-top:5px;">
						<textarea name="comment_body" class="form-control" id="reply-body" placeholder=""></textarea>
					</div>
					<div class="form-group" style="margin-top:5px;text-align:left;" >
						<button type="submit" class="btn btn-primary"><i class="fa fa-check"></i> Post a reply</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

        {% include "photomodal.html" %}
    {% endif %}
{% endblock %}


